name: tinyos
display-name: tinyos
revision: 1
architecture: amd64
series: jammy
class: preinstalled
kernel: linux-generic-hwe-22.04
gadget:
  url: file://./pc-gadget/
  type: directory
rootfs:
  components:
    - main
    - universe
    - restricted
  pocket: updates
  seed:
    urls:
      - git://git.launchpad.net/~ubuntu-core-dev/ubuntu-seeds/+git/
    branch: jammy
    names:
      - server
      - server-minimal
  sources-list-deb822: true
customization:
  components:
    - main
    - universe
    - restricted
  pocket: updates
  manual:
    make-dirs:
      - path: /opt/tinybox/tinyturing/
        permissions: 0755
      - path: /opt/tinybox/service/
        permissions: 0755
      - path: /opt/tinybox/setup/
        permissions: 0755
      - path: /raid/
        permissions: 0777
    copy-file:
      # default grub config
      - source: ./misc/grub
        destination: /etc/default/grub
      # fix raid array mounting quirks
      - source: ./misc/mdadm.conf
        destination: /etc/mdadm/mdadm.conf
      # displayservice
      - source: ./tinyturing/display.py
        destination: /opt/tinybox/tinyturing/display.py
      - source: ./service/logo.png
        destination: /opt/tinybox/service/logo.png
      - source: ./tinyturing/font.npy
        destination: /opt/tinybox/tinyturing/font.npy
      - source: ./service/displayservice.py
        destination: /opt/tinybox/service/displayservice.py
      - source: ./service/displayservice.service
        destination: /etc/systemd/system/displayservice.service
      # displayservice hooks
      - source: ./service/bootup.sh
        destination: /opt/tinybox/service/bootup.sh
      - source: ./service/reboot.sh
        destination: /opt/tinybox/service/reboot.sh
      - source: ./service/poweroff.sh
        destination: /opt/tinybox/service/poweroff.sh
      - source: ./service/sleeping.sh
        destination: /opt/tinybox/service/sleeping.sh
      - source: ./service/reboot.service
        destination: /etc/systemd/system/reboot.service
      - source: ./service/poweroff.service
        destination: /etc/systemd/system/poweroff.service
      - source: ./service/sleeping.service
        destination: /etc/systemd/system/sleeping.service
      # setup
      - source: ./setup/adduser.sh
        destination: /opt/tinybox/setup/adduser.sh
      - source: ./setup/ensuredspackage.sh
        destination: /opt/tinybox/setup/ensuredspackage.sh
      - source: ./setup/update.sh
        destination: /opt/tinybox/setup/update.sh
      - source: ./setup/raidsetup.sh
        destination: /opt/tinybox/setup/raidsetup.sh
      - source: ./setup/driverinstall.sh
        destination: /opt/tinybox/setup/driverinstall.sh
      - source: ./setup/initialpackage.sh
        destination: /opt/tinybox/setup/initialpackage.sh
      - source: ./setup/correctperms.sh
        destination: /opt/tinybox/setup/correctperms.sh
      - source: ./setup/firstsetup.sh
        destination: /opt/tinybox/setup/firstsetup.sh
      - source: ./setup/firstsetup.service
        destination: /etc/systemd/system/firstsetup.service
      # tools
      - source: ./tools/fan-control
        destination: /usr/bin/fan-control
      - source: ./tools/fan-control_completion.sh
        destination: /etc/bash_completion.d/fan-control_completion.sh
      - source: ./tools/power-limit
        destination: /usr/bin/power-limit
      - source: ./tools/power-limit_completion.sh
        destination: /etc/bash_completion.d/power-limit_completion.sh
  cloud-init:
    user-data: |
      #cloud-config
      preserve_hostname: true
      bootcmd:
        - [ cloud-init-per, once, enabledisplayservice, systemctl, enable, displayservice.service ]
        - [ cloud-init-per, always, startdisplayservice, systemctl, start, displayservice.service ]
      mounts:
        - [ /dev/md/0, /raid, auto, "defaults,noatime,nofail", "0", "2" ]
      runcmd:
        - [ cloud-init-per, once, enabledisplayservice, systemctl, enable, displayservice.service ]
        - [ cloud-init-per, always, startdisplayservice, systemctl, start, displayservice.service ]
        - [ cloud-init-per, once, enablepoweroff, systemctl, enable, poweroff.service ]
        - [ cloud-init-per, once, enablereboot, systemctl, enable, reboot.service ]
        - [ cloud-init-per, once, enablesleeping, systemctl, enable, sleeping.service ]
        - [ cloud-init-per, once, bootup, bash, /opt/tinybox/service/bootup.sh ]
        - [ cloud-init-per, once, hostname, hostnamectl, hostname, tinybox ]
        - [ cloud-init-per, once, adduser, bash, /opt/tinybox/setup/adduser.sh ]
        - [ cloud-init-per, once, update, bash, /opt/tinybox/setup/update.sh ]
        - [ cloud-init-per, once, raidsetup, bash, /opt/tinybox/setup/raidsetup.sh ]
        - [ cloud-init-per, once, driverinstall, bash, /opt/tinybox/setup/driverinstall.sh ]
        - [ cloud-init-per, once, initialpackage, bash, /opt/tinybox/setup/initialpackage.sh ]
        - [ cloud-init-per, always, correctperms, bash, /opt/tinybox/setup/correctperms.sh ]
        - [ cloud-init-per, once, enablefirstsetup, systemctl, enable, firstsetup.service ]
        - [ cloud-init-per, once, ensuredspackage, bash, /opt/tinybox/setup/ensuredspackage.sh ]
        - [ cloud-init-per, once, reboot, bash, /opt/tinybox/service/reboot.sh ]
      power_state:
        delay: now
        mode: reboot
        message: Rebooting after setup
        condition: true
    meta-data: |
      dsmode: local
  extra-packages:
    # bootloader
    - name: grub-efi-amd64-signed
    - name: shim-signed
    - name: grub2-common
    # preinstalled
    - name: bash-completion
    - name: build-essential
    - name: clang
    - name: ipmitool
    - name: btop
    - name: rsync
    # for displayservice
    - name: python3
    - name: python3-pip
    - name: python3-numpy
    - name: python3-numba
    - name: python3-pillow
    - name: python3-serial
    - name: python3-psutil
    - name: netcat-openbsd
  extra-snaps:
    # required
    - name: snapd
    - name: core20
    # preinstalled
    - name: nvtop
artifacts:
  img:
    - name: tinyos.img
  manifest:
    name: tinyos.manifest
